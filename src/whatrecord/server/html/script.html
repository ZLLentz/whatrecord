<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WhatRecord? Startup Scripts</title>
  <script src="https://unpkg.com/vue@3"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
  <link rel="stylesheet" href="/_static/style.css">
  <!-- prod: <script src="https://cdn.jsdelivr.net/npm/vue@2"></script> -->
</head>
<body>

<div id="whatrec-ioc">
  <div>
    <h2>{{ path }}</h2>
    <br/>
    <pre>
      <script-line v-for="line in lines"
         v-bind:argv="line.argv"
         v-bind:context="line.context"
         v-bind:error="line.error"
         v-bind:line="line.line"
         v-bind:outputs="line.outputs"
         v-bind:redirects="line.redirects"
         v-bind:result="line.result"
      ></script-line>
    </pre>
  </div>
</div>

<script>

const WhatRecIOC = {
  data() {
    return {
      path: "",
      lines: [],
    }
  },
  mounted() {
    const url_params = new URLSearchParams(window.location.search);
    axios.get(
      "/api/script/info",
      {params:
        {
          script: url_params.get("script")
        }
      }
    )
      .then(response => {
        this.path = response.data.path;
        this.lines = response.data.lines;
        document.title = "WhatRec? " + this.path;
      })
      .catch(error => {
        console.log(error)
      });
  },
  updated() {
    var hash = window.location.hash.substr(1);
    if (hash != "") {
      var obj = document.getElementById(hash);
      if (obj != null) {
        obj.scrollIntoView();
      }
    }
  }
}
const app = Vue.createApp(WhatRecIOC)

app.component('db-context-link', {
  props: ["filename", "line"],
  template: `
  <a v-bind:href="'/database?file=' + filename + '#' + line" target="_blank">Line {{line}}</a>
`
})

app.component('linter-results', {
  props: ["load_count", "errors", "warnings", "macros"],
  template: `
<div class="result-block">
  Records loaded: {{ load_count }}<br/>
  <br/>
  Macros:<br/>
  <dictionary-table
    :dict="macros"
    :cls="'metadata'"
    :skip_keys="[]">
  </dictionary-table>
</div>
<div class="error-block">
  <template v-for="error in errors" class="error-block">
    <db-context-link v-bind:filename="error.file" v-bind:line=error.line></db-context-link>
    '{{error.name}}' error: {{error.message}}<br/>
  </template>
  <template v-for="warning in warnings" class="error-block">
    <db-context-link v-bind:filename="warning.file" v-bind:line=warning.line></db-context-link>
    '{{warning.name}}' warning: {{warning.message}}<br/>
  </template>
</div>
`
})

app.component('script-line', {
  props: ["context", "line", "outputs", "argv", "error", "redirects", "result"],
  template: `
  <template v-if="result == null && error == null">
    <span class="script-line" v-bind:id="context.map(ctx => ctx[0] + ':' + ctx[1]).join(',')">
      {{ context.map(ctx => ctx[1]).join(':') }}: {{line}}
    </span>
    <br/>
  </template>
  <template v-else>
    <details v-bind:id="context.map(ctx => ctx[0] + ':' + ctx[1]).join(',')">
      <summary class="script-line">
        {{ context.map(ctx => ctx[1]).join(':') }}:
        <span v-if="error != null" class="script-error-line">
          {{line}}
        </span>
        <span v-else-if="result != null && result.hasOwnProperty('load_count') && (result.errors.length > 0 || result.warnings.length > 0)" class="script-error-line">
          {{line}}
        </span>
        <span v-else class="script-line">{{line}}</span>
      </summary>

      <template v-if="result != null && result.hasOwnProperty('load_count')">
        <linter-results
          v-bind:load_count="result.load_count"
          v-bind:errors="result.errors"
          v-bind:warnings="result.warnings"
          v-bind:macros="result.macros"
        ></linter-results>
      </template>
      <template v-else>
        <span v-if="error != null" class="error-block">
          {{error}}
        </span>
        <span v-if="result != null" class="result-block">
          {{ result }}
        </span>
      </template>
    </details>
    </template>
`
})

app.mount('#whatrec-ioc')

  </script>
</body>
</html>
